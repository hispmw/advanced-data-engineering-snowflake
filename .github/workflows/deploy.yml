name: Deploy to Snowflake

on:
  push:
    branches: [ main, staging ]
  pull_request:
    types: [ closed ]

jobs:
  deploy:
    if: github.event_name == 'push' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      SNOWFLAKE_ACCOUNT:     ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER:        ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Snowflake CLI
        run: pip install --upgrade snowflake-cli-labs

      - name: Set up secure JWT connection
        run: |
          echo "$SNOWFLAKE_PRIVATE_KEY" > /tmp/key.p8
          chmod 600 /tmp/key.p8
          mkdir -p ~/.snowflake && chmod 700 ~/.snowflake
          cat > ~/.snowflake/connections.toml <<'EOF'
          [ci]
          account       = "${{ secrets.SNOWFLAKE_ACCOUNT }}"
          user          = "${{ secrets.SNOWFLAKE_USER }}"
          authenticator = "SNOWFLAKE_JWT"
          private_key_path = "/tmp/key.p8"
          EOF
          chmod 600 ~/.snowflake/connections.toml

      # Auto-detect environment: main → prod, staging → staging
      - name: Determine target environment
        id: env
        run: |
          if [[ "${{ github.base_ref || github.ref_name }}" == "main" ]]; then
            echo "env=prod" >> $GITHUB_OUTPUT
          else
            echo "env=staging" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Snowflake Git branch
        run: |
          snow sql -q "USE DATABASE COURSE_REPO" --connection ci
          snow git fetch course_repo.public.advanced_data_engineering_snowflake --connection ci
          snow git execute \
            "@advanced_data_engineering_snowflake/branches/main/module-1/hamburg_weather/pipeline/data/" \
            --connection ci \
            --database COURSE_REPO \
            --schema PUBLIC \
            -D env=main

      - run: echo "Deployed to ${{ steps.env.outputs.env }} — LAB COMPLETE!"
